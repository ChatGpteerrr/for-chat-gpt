local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer

local function attachGui(gui)
    gui.ResetOnSpawn = false

    if type(syn) == "table" and syn.protect_gui then
        pcall(function()
            syn.protect_gui(gui)
        end)

        if gethui then
            gui.Parent = gethui()
            return
        end
    end

    if gethui then
        gui.Parent = gethui()
    else
        local success, playerGui = pcall(function()
            return localPlayer:WaitForChild("PlayerGui")
        end)

        if success and playerGui then
            gui.Parent = playerGui
        else
            gui.Parent = game:GetService("CoreGui")
        end
    end
end

local currentCharacter = nil
local currentHumanoid = nil
local currentRootPart = nil

local lastDashTime = 0
local dashCooldown = 0.35
local stickDashEnabled = true
local cooldownRunning = false
local cooldownDuration = 7.2
local dashRecoveryExtraDelay = 0.3

local function getNearestTargetCharacter()
    local nearestModel = nil
    local nearestDistance = math.huge

    if not currentRootPart then
        return nil
    end

    for _, descendant in ipairs(workspace:GetDescendants()) do
        if descendant:IsA("Model") and descendant ~= currentCharacter and descendant:FindFirstChild("HumanoidRootPart") then
            local success, distance = pcall(function()
                return (currentRootPart.Position - descendant.HumanoidRootPart.Position).Magnitude
            end)

            if success and distance and distance < nearestDistance then
                nearestDistance = distance
                nearestModel = descendant
            end
        end
    end

    return nearestModel
end

local function sendDashRemoteEvents()
    task.delay(0.1, function()
        pcall(function()
            local dashPayload = {
                {
                    Dash = Enum.KeyCode.W,
                    Key = Enum.KeyCode.Q,
                    Goal = "KeyPress"
                }
            }

            if currentCharacter and currentCharacter:FindFirstChild("Communicate") then
                currentCharacter.Communicate:FireServer(unpack(dashPayload))
            end
        end)
    end)

    local function findNilInstanceByNameAndClass(instanceName, className)
        if type(getnilinstances) ~= "function" then
            return nil
        end

        for _, inst in pairs(getnilinstances()) do
            if inst.ClassName == className and inst.Name == instanceName then
                return inst
            end
        end
    end

    pcall(function()
        local deletePayload = {
            {
                Goal = "delete bv",
                BV = findNilInstanceByNameAndClass("moveme", "BodyVelocity")
            }
        }

        if currentCharacter and currentCharacter:FindFirstChild("Communicate") then
            currentCharacter.Communicate:FireServer(unpack(deletePayload))
        end
    end)
end

local function performStickDash()
    if not (currentCharacter and currentHumanoid and currentRootPart) then
        return
    end

    local targetModel = getNearestTargetCharacter()
    if not targetModel then
        return
    end

    local targetRootPart = targetModel:FindFirstChild("HumanoidRootPart")
    if not targetRootPart then
        return
    end

    local savedHumanoidState = {}
    pcall(function()
        savedHumanoidState.WalkSpeed = currentHumanoid.WalkSpeed
        savedHumanoidState.JumpPower = currentHumanoid.JumpPower
        savedHumanoidState.PlatformStand = currentHumanoid.PlatformStand

        if currentHumanoid:GetAttribute("AutoRotate") ~= nil then
            savedHumanoidState.AutoRotate = currentHumanoid.AutoRotate
        else
            pcall(function()
                savedHumanoidState.AutoRotate = currentHumanoid.AutoRotate
            end)
        end
    end)

    local freezeHeartbeatConnection = nil

    local function freezeCharacter()
        if currentHumanoid and currentRootPart and currentCharacter then
            pcall(function()
                currentHumanoid.WalkSpeed = 0
                currentHumanoid.JumpPower = 0
                currentHumanoid.PlatformStand = true

                pcall(function()
                    currentHumanoid.AutoRotate = false
                end)

                currentRootPart.Velocity = Vector3.new(0, 0, 0)
                currentRootPart.RotVelocity = Vector3.new(0, 0, 0)
            end)

            for _, descendant in pairs(currentCharacter:GetDescendants()) do
                local className = descendant.ClassName
                if className == "BodyVelocity"
                    or className == "BodyPosition"
                    or className == "BodyGyro"
                    or className == "VectorForce"
                    or className == "AlignPosition"
                    or className == "AlignOrientation"
                    or className == "LinearVelocity"
                    or className == "AngularVelocity" then

                    pcall(function()
                        descendant:Destroy()
                    end)
                end
            end

            freezeHeartbeatConnection = RunService.Heartbeat:Connect(function()
                if currentRootPart then
                    pcall(function()
                        currentRootPart.Velocity = Vector3.new(0, 0, 0)
                        currentRootPart.RotVelocity = Vector3.new(0, 0, 0)
                    end)
                end

                if currentHumanoid and currentHumanoid.WalkSpeed then
                    pcall(function()
                        currentHumanoid.WalkSpeed = 0
                    end)
                end
            end)
        end
    end

    local function restoreCharacter()
        if freezeHeartbeatConnection and freezeHeartbeatConnection.Disconnect then
            pcall(function()
                freezeHeartbeatConnection:Disconnect()
            end)
        end

        pcall(function()
            if currentHumanoid then
                currentHumanoid.WalkSpeed = savedHumanoidState.WalkSpeed or 16
                currentHumanoid.JumpPower = savedHumanoidState.JumpPower or 50
                currentHumanoid.PlatformStand = savedHumanoidState.PlatformStand or false

                if savedHumanoidState.AutoRotate ~= nil then
                    pcall(function()
                        currentHumanoid.AutoRotate = savedHumanoidState.AutoRotate
                    end)
                end
            end

            if currentRootPart then
                currentRootPart.Velocity = Vector3.new(0, 0, 0)
                currentRootPart.RotVelocity = Vector3.new(0, 0, 0)
            end
        end)
    end

    freezeCharacter()

    pcall(function()
        currentHumanoid:ChangeState(Enum.HumanoidStateType.Physics)
    end)

    currentRootPart.CFrame = currentRootPart.CFrame * CFrame.Angles(math.rad(85), 0, 0)

    local startTime = tick()
    local cframeFollowConnection = nil

    cframeFollowConnection = RunService.Heartbeat:Connect(function()
        if tick() - startTime < 0.7 then
            local success, newCFrame = pcall(function()
                return CFrame.new(targetRootPart.Position - targetRootPart.CFrame.LookVector * 0.3)
                    * CFrame.Angles(math.rad(85), 0, 0)
            end)

            if success and newCFrame and currentRootPart then
                currentRootPart.CFrame = newCFrame
            end
        else
            if cframeFollowConnection then
                cframeFollowConnection:Disconnect()
            end
        end
    end)

    task.delay(0.18, function()
        pcall(sendDashRemoteEvents)
    end)

    task.delay(0.3, function()
        pcall(function()
            currentHumanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
        end)
    end)

    local restoreDelay = 0.7 + dashRecoveryExtraDelay
    task.delay(restoreDelay, function()
        pcall(restoreCharacter)
    end)
end

local mainGui = Instance.new("ScreenGui")
mainGui.Name = "Merebennie_StickDashGui"
mainGui.IgnoreGuiInset = true
attachGui(mainGui)

local toggleButton = Instance.new("TextButton")
toggleButton.Name = "StickDashToggle"
toggleButton.Size = UDim2.new(0, 60, 0, 30)
toggleButton.Position = UDim2.new(0.4, 0, 0.8, 0)
toggleButton.Text = "On"
toggleButton.Font = Enum.Font.GothamBold
toggleButton.TextSize = 14
toggleButton.BackgroundColor3 = Color3.fromRGB(30, 136, 229)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.Parent = mainGui
toggleButton.ZIndex = 9999
toggleButton.Active = true

Instance.new("UICorner", toggleButton).CornerRadius = UDim.new(0, 8)

local toggleStroke = Instance.new("UIStroke", toggleButton)
toggleStroke.Thickness = 1
toggleStroke.Transparency = 0.35

local isToggleDragging = nil
local toggleDragInput = nil
local toggleDragStart = nil
local toggleStartPos = nil

toggleButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isToggleDragging = true
        toggleDragStart = input.Position
        toggleStartPos = toggleButton.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                isToggleDragging = false
            end
        end)
    end
end)

toggleButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        toggleDragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == toggleDragInput and isToggleDragging and toggleStartPos then
        local delta = input.Position - toggleDragStart
        toggleButton.Position = UDim2.new(
            toggleStartPos.X.Scale,
            toggleStartPos.X.Offset + delta.X,
            toggleStartPos.Y.Scale,
            toggleStartPos.Y.Offset + delta.Y
        )
    end
end)

toggleButton.MouseButton1Click:Connect(function()
    stickDashEnabled = not stickDashEnabled

    if stickDashEnabled then
        toggleButton.Text = "On"
        toggleButton.BackgroundColor3 = Color3.fromRGB(30, 136, 229)
    else
        toggleButton.Text = "Off"
        toggleButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    end
end)

local cooldownFrame = Instance.new("Frame")
cooldownFrame.Name = "MerckCooldown"
cooldownFrame.Size = UDim2.new(0, 120, 0, 28)
cooldownFrame.Position = UDim2.new(0, 8, 1, -40)
cooldownFrame.AnchorPoint = Vector2.new(0, 0)
cooldownFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
cooldownFrame.BackgroundTransparency = 0.45
cooldownFrame.Visible = false
cooldownFrame.Parent = mainGui
cooldownFrame.ZIndex = 9998
cooldownFrame.Active = true

Instance.new("UICorner", cooldownFrame).CornerRadius = UDim.new(0, 12)

local cooldownStroke = Instance.new("UIStroke", cooldownFrame)
cooldownStroke.Thickness = 1
cooldownStroke.Transparency = 0.35

local cooldownLabel = Instance.new("TextLabel")
cooldownLabel.Name = "CooldownText"
cooldownLabel.Size = UDim2.new(1, -8, 1, 0)
cooldownLabel.Position = UDim2.new(0, 8, 0, 0)
cooldownLabel.BackgroundTransparency = 1
cooldownLabel.Text = "Merck V2 : 0.0s"
cooldownLabel.TextColor3 = Color3.new(0, 0, 0)
cooldownLabel.Font = Enum.Font.GothamBold
cooldownLabel.TextSize = 14
cooldownLabel.TextXAlignment = Enum.TextXAlignment.Left
cooldownLabel.Parent = cooldownFrame
cooldownLabel.ZIndex = 9999

local cooldownTween = TweenService:Create(
    cooldownFrame,
    TweenInfo.new(0.6, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true),
    { BackgroundTransparency = 0.35 }
)

local cooldownTweenPlaying = false

local function startCooldown(duration)
    if cooldownRunning then
        return
    end

    cooldownRunning = true
    cooldownFrame.Visible = true

    if not cooldownTweenPlaying then
        cooldownTweenPlaying = true
        pcall(function()
            cooldownTween:Play()
        end)
    end

    local startTime = tick()
    local totalDuration = duration

    while duration > 0 do
        local remaining = totalDuration - (tick() - startTime)
        duration = remaining < 0 and 0 or remaining
        cooldownLabel.Text = string.format("Merck V2 : %.1fs", duration)
        task.wait(0.1)
    end

    cooldownRunning = false
    cooldownFrame.Visible = false

    pcall(function()
        cooldownTween:Cancel()
    end)

    cooldownTweenPlaying = false
end

local infoFrame = Instance.new("Frame")
infoFrame.Name = "MerebennieInfoBox"
infoFrame.Size = UDim2.new(0, 200, 0, 92)
infoFrame.Position = UDim2.new(0.05, 0, 0.12, 0)
infoFrame.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
infoFrame.Parent = mainGui
infoFrame.ZIndex = 10000
infoFrame.Active = true

Instance.new("UICorner", infoFrame).CornerRadius = UDim.new(0, 10)
Instance.new("UIStroke", infoFrame).Transparency = 0.35

local infoTitle = Instance.new("TextLabel")
infoTitle.Name = "InfoTitle"
infoTitle.Size = UDim2.new(1, -40, 0, 24)
infoTitle.Position = UDim2.new(0, 10, 0, 6)
infoTitle.BackgroundTransparency = 1
infoTitle.Text = "Made by Merebennie"
infoTitle.TextColor3 = Color3.fromRGB(30, 30, 30)
infoTitle.Font = Enum.Font.GothamBold
infoTitle.TextSize = 14
infoTitle.TextXAlignment = Enum.TextXAlignment.Left
infoTitle.Parent = infoFrame
infoTitle.ZIndex = 10001

local infoCloseButton = Instance.new("TextButton")
infoCloseButton.Name = "InfoClose"
infoCloseButton.Size = UDim2.new(0, 22, 0, 22)
infoCloseButton.Position = UDim2.new(1, -28, 0, 6)
infoCloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
infoCloseButton.Text = "X"
infoCloseButton.Font = Enum.Font.GothamBold
infoCloseButton.TextSize = 14
infoCloseButton.TextColor3 = Color3.new(1, 1, 1)
infoCloseButton.Parent = infoFrame
infoCloseButton.ZIndex = 10002

Instance.new("UICorner", infoCloseButton).CornerRadius = UDim.new(0, 6)

infoCloseButton.MouseButton1Click:Connect(function()
    infoFrame.Visible = false
end)

local infoDescription = Instance.new("TextLabel")
infoDescription.Name = "InfoDesc"
infoDescription.Size = UDim2.new(1, -20, 0, 34)
infoDescription.Position = UDim2.new(0, 10, 0, 32)
infoDescription.BackgroundTransparency = 1
infoDescription.TextWrapped = true
infoDescription.Text = "Join our discord for more Scripts!\nhttps://discord.gg/5x4xbPvuSc"
infoDescription.TextColor3 = Color3.fromRGB(40, 40, 40)
infoDescription.Font = Enum.Font.Gotham
infoDescription.TextSize = 12
infoDescription.TextXAlignment = Enum.TextXAlignment.Left
infoDescription.TextYAlignment = Enum.TextYAlignment.Top
infoDescription.Parent = infoFrame
infoDescription.ZIndex = 10001

local copyLinkButton = Instance.new("TextButton")
copyLinkButton.Name = "InfoCopy"
copyLinkButton.Size = UDim2.new(0, 96, 0, 26)
copyLinkButton.Position = UDim2.new(0, 10, 1, -34)
copyLinkButton.Text = "Copy Link"
copyLinkButton.Font = Enum.Font.GothamBold
copyLinkButton.TextSize = 12
copyLinkButton.BackgroundColor3 = Color3.fromRGB(30, 136, 229)
copyLinkButton.TextColor3 = Color3.new(1, 1, 1)
copyLinkButton.Parent = infoFrame
copyLinkButton.ZIndex = 10001

Instance.new("UICorner", copyLinkButton).CornerRadius = UDim.new(0, 6)

copyLinkButton.MouseButton1Click:Connect(function()
    pcall(function()
        if setclipboard then
            setclipboard("https://discord.gg/5x4xbPvuSc")
        elseif toclipboard then
            toclipboard("https://discord.gg/5x4xbPvuSc")
        end
    end)
end)

local isInfoDragging = nil
local infoDragInput = nil
local infoDragStart = nil
local infoStartPos = nil

infoFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isInfoDragging = true
        infoDragStart = input.Position
        infoStartPos = infoFrame.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                isInfoDragging = false
            end
        end)
    end
end)

infoFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        infoDragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == infoDragInput and isInfoDragging and infoStartPos then
        local delta = input.Position - infoDragStart

        local camera = workspace.CurrentCamera
        local viewportSize = camera and camera.ViewportSize or Vector2.new(1920, 1080)

        local newX = math.clamp(infoStartPos.X.Offset + delta.X, 0, math.max(0, viewportSize.X - infoFrame.AbsoluteSize.X))
        local newY = math.clamp(infoStartPos.Y.Offset + delta.Y, 0, math.max(0, viewportSize.Y - infoFrame.AbsoluteSize.Y))

        infoFrame.Position = UDim2.new(infoStartPos.X.Scale, newX, infoStartPos.Y.Scale, newY)
    end
end)

local animationConnections = {}

local function clearAnimationConnections()
    for _, connection in pairs(animationConnections) do
        if connection and connection.Disconnect then
            pcall(function()
                connection:Disconnect()
            end)
        end
    end

    animationConnections = {}
end

local function tryTriggerStickDash()
    if stickDashEnabled and not cooldownRunning then
        if dashCooldown <= tick() - lastDashTime then
            lastDashTime = tick()

            task.spawn(function()
                pcall(performStickDash)
            end)

            task.spawn(function()
                startCooldown(cooldownDuration)
            end)
        end
    end
end

local function onAnimationTrackPlayed(animationTrack)
    if not animationTrack then
        return
    end

    local animation = animationTrack.Animation
    if not animation then
        return
    end

    local animationId = tostring(animation.AnimationId or "")
    if string.find(animationId, "10503381238", 1, true) then
        tryTriggerStickDash()
    end
end

local function bindCharacter(character)
    clearAnimationConnections()

    currentCharacter = character
    currentHumanoid = character:FindFirstChildOfClass("Humanoid") or character:WaitForChild("Humanoid", 5)
    currentRootPart = character:FindFirstChild("HumanoidRootPart") or character:WaitForChild("HumanoidRootPart", 5)

    if currentHumanoid and currentRootPart then
        local successHumanoid, connHumanoid = pcall(function()
            return currentHumanoid.AnimationPlayed:Connect(onAnimationTrackPlayed)
        end)

        if successHumanoid and connHumanoid then
            table.insert(animationConnections, connHumanoid)
        end

        local animator = currentHumanoid:FindFirstChildOfClass("Animator")
        if animator then
            local successAnimator, connAnimator = pcall(function()
                return animator.AnimationPlayed:Connect(onAnimationTrackPlayed)
            end)

            if successAnimator and connAnimator then
                table.insert(animationConnections, connAnimator)
            end
        end

        local descendantConnection = character.DescendantAdded:Connect(function(descendant)
            if descendant:IsA("Animation") then
                local animationId = tostring(descendant.AnimationId or "")
                if string.find(animationId, "10503381238", 1, true) then
                    tryTriggerStickDash()
                end
            end
        end)

        table.insert(animationConnections, descendantConnection)
    end
end

localPlayer.CharacterAdded:Connect(function(character)
    task.wait(0.1)
    pcall(bindCharacter, character)
end)

if localPlayer.Character then
    pcall(bindCharacter, localPlayer.Character)
end
